<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
		<script src="../../webcomponentsjs/webcomponents-lite.js"></script>
		<script src="../../web-component-tester/browser.js"></script>

		<link rel="import" href="../d2l-search-widget.html">
	</head>
	<body>
		<test-fixture id="search-widget-basic">
			<template>
				<d2l-search-widget></d2l-search-widget>
			</template>
		</test-fixture>

		<test-fixture id="search-widget">
			<template>
				<d2l-search-widget
					search-action='{"name": "do-a-thing", "method": "GET", "href": "/some/url", "fields": [{"name": "query", "type": "search", "value": ""}]}'
					search-field-name="query"></d2l-search-widget>
			</template>
		</test-fixture>

		<test-fixture id="search-widget-cached">
			<template>
				<d2l-search-widget
					search-action='{"name": "do-a-thing", "method": "GET", "href": "/some/url", "fields": [{"name": "query", "type": "search", "value": ""}]}'
					search-field-name="query"
					cache-responses="true"></d2l-search-widget>
			</template>
		</test-fixture>

		<script>
		/* global describe, it, beforeEach, afterEach, fixture, expect, sinon */
		'use strict';

		describe('d2l-search-widget', function() {
			var searchWidget,
				searchWidgetBasic,
				searchWidgetCached,
				server,
				entity = {
					class: ['foo'],
					properties: {
						name: 'a-thing'
					},
					actions: [{
						name: 'do-a-thing',
						method: 'GET',
						href: '/some/url',
						fields: [{
							name: 'query',
							type: 'search',
							value: ''
						}]
					}]
				};

			beforeEach(function() {
				searchWidget = fixture('search-widget');
				searchWidgetBasic = fixture('search-widget-basic');
				searchWidgetCached = fixture('search-widget-cached');
				server = sinon.fakeServer.create();
				server.respondImmediately = true;
			});

			afterEach(function() {
				server.restore();
			});

			it('has sensible defaults', function() {
				expect(searchWidgetBasic.searchAction).to.be.undefined;
				expect(searchWidgetBasic.searchFieldName).to.equal('search');
			});

			it('can have searchAction and searchFieldName set', function() {
				searchWidgetBasic.searchAction = entity.actions[0];
				searchWidgetBasic.searchFieldName = 'query';
				expect(searchWidgetBasic.searchAction).to.be.an('object').with.property('name').that.equals('do-a-thing');
				expect(searchWidgetBasic.searchFieldName).to.equal('query');
			});

			it('correctly parses search-action and search-field-name attributes', function() {
				expect(searchWidget.searchAction).to.be.an('object').with.property('name').that.equals('do-a-thing');
				expect(searchWidget.searchFieldName).to.equal('query');
			});

			it('should fire a d2l-search-widget-results-changed event when search completes', function(done) {
				server.respondWith(
					'GET',
					/.*/,
					function(req) {
						req.respond(200, {}, JSON.stringify(entity));
					});

				searchWidget._searchInput = 'foo';
				var listener = function(e) {
					expect(e.detail).to.be.an('object');
					expect(e.detail.properties.name).to.equal('a-thing');
					document.removeEventListener('d2l-search-widget-results-changed', listener, false);
					done();
				};
				document.addEventListener('d2l-search-widget-results-changed', listener);
				searchWidget.search();
			});

			it('should fire a d2l-search-widget-results-changed event when the search is cleared', function(done) {
				server.respondWith(
					'GET',
					/.*/,
					function(req) {
						req.respond(200, {}, JSON.stringify({}));
					});

				searchWidget._searchInput = 'foo';
				searchWidget.search();
				var listener = function(e) {
					expect(e.detail).to.be.an('object');
					expect(e.detail.properties).to.be.undefined;
					document.removeEventListener('d2l-search-widget-results-changed', listener, false);
					done();
				};
				document.addEventListener('d2l-search-widget-results-changed', listener);
				searchWidget.clear();
			});

			it('should URI-encode query strings', function(done) {
				server.respondWith(
					'GET',
					/.*/,
					function(req) {
						expect(req.url).to.match(/something%26something%20something/);
						req.respond(200, {}, JSON.stringify({}));
					});

				searchWidget._searchInput = 'something&something something';
				var listener = function() {
					document.removeEventListener('d2l-search-widget-results-changed', listener, false);
					done();
				};
				document.addEventListener('d2l-search-widget-results-changed', listener);
				searchWidget.search();
			});

			describe('button icon', function() {
				beforeEach(function() {
					searchWidget._searchInput = 'foo';
				});

				it('should default to a search icon and correct ARIA label', function() {
					expect(searchWidget.$$('button > d2l-icon').getAttribute('icon')).to.contain('search');
					expect(searchWidget.$$('button').getAttribute('aria-label')).to.equal('Search');
				});

				it('should change to an X icon when a search is done', function(done) {
					server.respondWith('GET', /.*/, [200, {}, JSON.stringify({})]);

					var listener = function() {
						expect(searchWidget._showClearIcon).to.be.true;
						expect(searchWidget.$$('button > d2l-icon').getAttribute('icon')).to.contain('close-default');
						expect(searchWidget.$$('button').getAttribute('aria-label')).to.equal('Clear Search');
						document.removeEventListener('d2l-search-widget-results-changed', listener, false);
						done();
					};
					document.addEventListener('d2l-search-widget-results-changed', listener);
					searchWidget.$$('button').click();
				});

				it('should change to a search icon when cleared', function(done) {
					server.respondWith('GET', /.*/, [200, {}, JSON.stringify({})]);

					searchWidget.search();
					expect(searchWidget.$$('button > d2l-icon').getAttribute('icon')).to.contain('close-default');

					var listener = function() {
						expect(searchWidget._showClearIcon).to.be.false;
						expect(searchWidget.$$('d2l-icon').getAttribute('icon')).to.contain('search');
						expect(searchWidget.$$('button').getAttribute('aria-label')).to.equal('Search');
						document.removeEventListener('d2l-search-widget-results-changed', listener, false);
						done();
					};
					document.addEventListener('d2l-search-widget-results-changed', listener);
					searchWidget.$$('button').click();
				});

				it('should switch back to search icon when search string is updated', function(done) {
					server.respondWith('GET', /.*/, [200, {}, JSON.stringify({})]);

					var listener = function() {
						expect(searchWidget._showClearIcon).to.be.true;
						expect(searchWidget.$$('button > d2l-icon').getAttribute('icon')).to.contain('close-default');
						expect(searchWidget.$$('button').getAttribute('aria-label')).to.equal('Clear Search');

						searchWidget._searchInput = 'foobar';
						expect(searchWidget._showClearIcon).to.be.false;
						expect(searchWidget.$$('button > d2l-icon').getAttribute('icon')).to.contain('search');
						expect(searchWidget.$$('button').getAttribute('aria-label')).to.equal('Search');
						document.removeEventListener('d2l-search-widget-results-changed', listener, false);
						done();
					};
					document.addEventListener('d2l-search-widget-results-changed', listener);
					searchWidget.$$('button').click();
				});
			});

			describe('cacheResponses', function() {
				it('should not cache responses by default', function(done) {
					var url;
					server.respondWith(
						'GET',
						/.*/,
						function(req) {
							url = req.url;
							req.respond(200, {}, JSON.stringify(entity));
						});

					var listener = function() {
						expect(searchWidget._searchResultsCache[url]).to.be.undefined;
						document.removeEventListener('d2l-search-widget-results-changed', listener, false);
						done();
					};
					document.addEventListener('d2l-search-widget-results-changed', listener);
					searchWidget._searchInput = 'foo';
					searchWidget.search();
				});

				it('should cache the response for a given URL', function(done) {
					var url;
					server.respondWith(
						'GET',
						/.*/,
						function(req) {
							url = req.url;
							req.respond(200, {}, JSON.stringify(entity));
						});

					var listener = function() {
						expect(searchWidgetCached._searchResultsCache[url]).to.not.be.undefined;
						document.removeEventListener('d2l-search-widget-results-changed', listener, false);
						done();
					};
					document.addEventListener('d2l-search-widget-results-changed', listener);
					searchWidgetCached._searchInput = 'foo';
					searchWidgetCached.search();
				});

				it('should not re-request if a URLs response is already cached', function(done) {
					var url;
					server.respondWith(
						'GET',
						/.*/,
						function(req) {
							url = req.url;
							req.respond(200, {}, JSON.stringify(entity));
						});

					var spy;

					var firstListener = function() {
						// Initial search response - should hit fakeServer
						document.removeEventListener('d2l-search-widget-results-changed', firstListener, false);
						document.addEventListener('d2l-search-widget-results-changed', secondListener);
						expect(searchWidgetCached._searchResultsCache[url]).to.not.be.undefined;
						searchWidgetCached.clear();
					};
					var secondListener = function() {
						// Clearing search response - should hit fakeServer
						document.removeEventListener('d2l-search-widget-results-changed', secondListener, false);
						document.addEventListener('d2l-search-widget-results-changed', thirdListener);
						spy = sinon.spy(searchWidgetCached.$$('d2l-ajax'), 'generateRequest');
						searchWidgetCached._searchInput = 'bar';
						searchWidgetCached.search();
					};
					var thirdListener = function() {
						// Second 'foo' search response - should hit cached responses
						document.removeEventListener('d2l-search-widget-results-changed', thirdListener, false);
						expect(spy.called).to.be.false;
						done();
					};
					document.addEventListener('d2l-search-widget-results-changed', firstListener);
					searchWidgetCached._searchInput = 'bar';
					searchWidgetCached.search();
				});

				it('should clear entire cache if no key specified', function() {
					searchWidgetCached._searchResultsCache['foo'] = entity;
					searchWidgetCached.clearCache();
					expect(searchWidgetCached._searchResultsCache['foo']).to.be.undefined;
				});

				it('should clear specific cache entry if key specified', function() {
					searchWidgetCached._searchResultsCache['foo'] = entity;
					searchWidgetCached._searchResultsCache['bar'] = entity;
					searchWidgetCached.clearCache('bar');
					expect(searchWidgetCached._searchResultsCache['foo']).to.not.be.undefined;
					expect(searchWidgetCached._searchResultsCache['bar']).to.be.undefined;
				});
			});
		});
		</script>
	</body>
</html>
