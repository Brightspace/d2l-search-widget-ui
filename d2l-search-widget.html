<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="d2l-utility-behavior.html">

<!--
`<d2l-search-widget>` is a self-contained search widget.

@demo demo/d2l-search-widget-demo.html
-->
<dom-module id="d2l-search-widget">
	<template>
		<style include="d2l-colors"></style>
		<style>
			:host {
				position: relative;
				display: block;
				min-width: 100px;
				min-height: 60px;
				padding: 0;
				margin: 0;
			}
			input {
				width: 100%;
				height: 60px;
				background-color: var(--d2l-color-white);
				border-color: var(--d2l-color-titanius);
				border-width: 1px;
				box-shadow: inset 0 2px 0 0 rgba(185,194,208,.2);
				padding: .4rem 1rem;
				border-radius: .3rem;
				border-style: solid;
				vertical-align: middle;
				font-size: 1rem;
				font-weight: 300;
				letter-spacing: .015rem;
				font-family: inherit;
				box-sizing: border-box;
				-webkit-transition-duration: .5s;
				transition-duration: .5s;
				-webkit-transition-timing-function: ease;
				transition-timing-function: ease;
				-webkit-transition-property: background-color,border-color;
				transition-property: background-color,border-color;
				padding-left: 65px;
				padding-right: 65px;
			}
			input:focus,
			input:hover {
				border-color: var(--d2l-color-celestine);
				border-width: 2px;
				outline-width: 0;
				padding: -webkit-calc(.4rem - 1px) -webkit-calc(1rem - 1px);
				padding: calc(.4rem - 1px) calc(1rem - 1px);
				padding-left: 64px;
				padding-right: 64px;
			}
			.search-icon {
				position: absolute;
				top: 0px;
				padding: 15px;
				background: none;
				border: none;
				margin: 0;
				cursor: pointer;
				height: 100%;
			}
			.search-icon iron-icon {
				width: 22px;
				height: 22px;
				color: var(--d2l-color-tungsten);
			}
			.search-button {
				left: 5px;
			}
			.clear-search-button {
				right: 5px;
			}
		</style>

		<d2l-ajax
			id="searchRequest"
			url="[[_searchUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onSearchResponse">
		</d2l-ajax>

		<div class="search-bar">
			<button type="button" on-tap="_onSearchButtonClick" class="search-icon search-button">
				<iron-icon icon="d2l-tier1:search"></iron-icon>
			</button>

			<input
				is="iron-input"
				bind-value="{{_searchString}}"
				role="combobox"
				aria-autocomplete="list"
				placeholder="{{placeholderText}}"
				on-keydown="_onSearchInputKeyPressed">
			</input>

			<button type="button" on-tap="_clearSearchResults" class="search-icon clear-search-button">
				<iron-icon icon="d2l-tier1:close-default"></iron-icon>
			</button>
		</div>
	</template>
	<script>
		'use strict';

		Polymer({
			is: 'd2l-search-widget',

			properties: {
				/*
				* Fired whenever the search results change
				*
				* This can either occur when a search request comes back with results, or
				* when the search field is cleared by the user. The detail of the event is
				* the search results, which can then be parsed in the handler.
				*
				* @event d2l-search-widget-results
				*/

				/*
				* Placeholder text that appears in the search field
				* @type {String}
				*/
				placeholderText: {
					type: String,
					value: ''
				},
				/*
				* Hypermedia Entity that contains search Action
				*/
				searchAction: {
					type: Object,
					observer: '_onSearchActionChanged'
				},
				/*
				* Name of the Hypermedia Field that typing into the search field mutates
				* @type {String}
				*/
				searchFieldName: {
					type: String,
					value: 'query'
				},
				/*
				* An array of objects containing the results of the search Action
				* @type {Array<Object>}
				*/
				lastResults: {
					type: Array,
					value: function() {
						return [];
					}
				},
				/*
				* Actual URL called for the search, generated from searchAction/FieldName
				* @type {String}
				*/
				_searchUrl: String,
				_searchString: {
					type: String,
					value: ''
				}
			},
			behaviors: [
				Polymer.D2L.SearchWidget.UtilityBehavior
			],
			_clearSearchResults: function() {
				this._searchString = '';
				this.set('lastResults', []);
				this.fire('d2l-search-widget-results', this.lastResults);
			},
			_onSearchActionChanged: function(searchAction) {
				// Siren parser can only parse entities, so make a fake one with the given action
				var entity = {
					actions: [ searchAction ]
				};
				var parser = document.createElement('d2l-siren-parser');
				this._searchAction = parser.parse(entity).actions[0];
			},
			_onSearchButtonClick: function() {
				if (!this._searchAction) {
					return;
				}

				if (this._searchString.length === 0) {
					this._clearSearchResults();
					return;
				}

				var query = {};
				query[this.searchFieldName] = this._searchString;

				this._searchUrl = this.createActionUrl(this._searchAction, query);
				this.$.searchRequest.generateRequest();
			},
			_onSearchInputKeyPressed: function(e) {
				// If Enter key pressed, do the search
				if (e.keyCode == 13) {
					this._onSearchButtonClick();
				}
			},
			_onSearchResponse: function(response) {
				if (response.detail.status === 200 || response.detail.status === 304) {
					var parser = document.createElement('d2l-siren-parser');
					var searchResponse = parser.parse(response.detail.xhr.response);
					this.set('lastResults', searchResponse.entities);
					this.fire('d2l-search-widget-results', this.lastResults);
				}
			}
		});
	</script>
</dom-module>
