<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-icons/d2l-icons.html">
<link rel="import" href="../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="localize-behavior.html">
<link rel="import" href="d2l-search-listbox.html">
<link rel="import" href="d2l-utility-behavior.html">
<link rel="import" href="d2l-search-dropdown-content.html">

<!--
`<d2l-search-widget>` is a self-contained search widget.

@demo demo/d2l-search-widget-demo.html
-->
<dom-module id="d2l-search-widget">
	<template>
		<style>
			:host {
				position: relative;
				display: block;
				min-width: 100px;
				min-height: 60px;
				padding: 0;
				margin: 0;
			}
			input {
				width: 100%;
				height: 60px;
				background-color: var(--d2l-color-white);
				border-color: var(--d2l-color-titanius);
				border-width: 1px;
				box-shadow: inset 0 2px 0 0 rgba(185,194,208,.2);
				padding: .4rem 1rem;
				border-radius: .3rem;
				border-style: solid;
				vertical-align: middle;
				font-size: 1rem;
				font-weight: 300;
				letter-spacing: .015rem;
				font-family: inherit;
				box-sizing: border-box;
				-webkit-transition-duration: .5s;
				transition-duration: .5s;
				-webkit-transition-timing-function: ease;
				transition-timing-function: ease;
				-webkit-transition-property: background-color,border-color;
				transition-property: background-color,border-color;
				padding-left: 65px;
				padding-right: 65px;
			}
			input:focus,
			input:hover {
				border-color: var(--d2l-color-celestine);
				border-width: 2px;
				outline-width: 0;
				padding: -webkit-calc(.4rem - 1px) -webkit-calc(1rem - 1px);
				padding: calc(.4rem - 1px) calc(1rem - 1px);
				padding-left: 64px;
				padding-right: 64px;
			}
			.dropdown-content {
				background: transparent;
			}
			d2l-dropdown {
				min-width: 100%;
			}
			d2l-search-listbox {
				border-radius: 6px;
			}
			.search-icon {
				position: absolute;
				top: 0px;
				padding: 15px;
				background: none;
				border: none;
				margin: 0;
				cursor: pointer;
				opacity: 0.7;
			}
			.search-icon:focus,
			.search-icon:hover {
				opacity: 1.0;
			}
			.search-icon iron-icon {
				width: 30px;
				height: 30px;
				color: var(--d2l-color-tungsten);
			}
			.search-button {
				left: 5px;
			}
			.clear-search-button {
				right: 5px;
			}
		</style>

		<d2l-ajax
			id="searchRequest"
			url="[[_searchUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onSearchResponse">
		</d2l-ajax>

		<d2l-dropdown no-auto-open>
			<div class="search-bar d2l-dropdown-opener" id="opener">
				<button type="button" on-tap="_onSearchButtonClick" class="search-icon search-button">
					<iron-icon icon="d2l-tier1:search"></iron-icon>
				</button>

				<input
					is="iron-input"
					bind-value="{{_searchString}}"
					role="combobox"
					aria-autocomplete="list"
					placeholder="{{localize('courseSearchInputPlaceholder')}}"
					on-keydown="_onSearchInputKeyPressed">
				</input>

				<button type="button" on-tap="_clearSearchResults" class="search-icon clear-search-button">
					<iron-icon icon="d2l-tier1:close-default"></iron-icon>
				</button>
			</div>
			<d2l-search-dropdown-content
				id="dropdown"
				no-pointer
				no-auto-close
				no-auto-focus
				no-padding>

				<div class="dropdown-content">
					<iron-pages selectable=".search-results-listbox-page" attr-for-selected="data-page-name" selected="recent-searches-page">
						<div class="search-results-listbox-page" data-page-name="recent-searches-page">
							<d2l-search-listbox>
								<div class="d2l-heading-4" data-list-title disabled>{{localize('recentSearches')}}</div>
								<template is="dom-repeat" items="[[_previousSearches]]">
									<div selectable data-text$="[[item]]" role="option">
										[[item]]
									</div>
								</template>
							</d2l-search-listbox>
						</div>

						<div class="search-results-listbox-page" data-page-name="search-results-page">
							<d2l-search-listbox>
								<template id="courseSearchResultsTemplate" is="dom-repeat" items="[[_searchResults]]">
									<div selectable data-text$="[[item.name]]" data-href$="[[item.href]]" role="option">
										[[item.name]]
									</div>
								</template>
							</d2l-search-listbox>
						</div>

						<div class="search-results-listbox-page" data-page-name="no-results-page">
							<d2l-search-listbox>
								<div disabled>{{localize('noSearchResults')}}</div>
							</d2l-search-listbox>
						</div>
					</iron-pages>
				</div>
			</d2l-search-dropdown-content>
		</d2l-dropdown>
	</template>
	<script>
		'use strict';

		Polymer({
			is: 'd2l-search-widget',

			properties: {
				/*
				* Hypermedia Entity that contains search Action
				*/
				searchAction: {
					type: Object,
					observer: '_onSearchActionChanged'
				},
				/*
				* Name of the Hypermedia Field that typing into the search field mutates
				* @type {String}
				*/
				searchFieldName: {
					type: String,
					value: 'query'
				},
				/*
				* Set to true if keypresses in the search box should refresh search results - otherwise, results are refreshed on ENTER
				* @type {Boolean}
				*/
				liveSearch: Boolean,
				/*
				* An array of objects containing the results of the search Action
				* @type {Array<Object>}
				*/
				_searchResults: {
					type: Array,
					value: function() {
						return [];
					}
				},
				/*
				* Actual URL called for the search, generated from searchAction/FieldName
				* @type {String}
				*/
				_searchUrl: String,
				_searchString: {
					type: String,
					value: '',
					observer: '_onSearchStringChanged'
				},
				/*
				* List of strings containing previously searched terms
				* @type {Array<String>}
				*/
				_previousSearches: {
					type: Array,
					value: function() {
						return [];
					}
				}
			},
			listeners: {
				'iron-select': '_onIronSelect'
			},
			behaviors: [
				Polymer.D2L.SearchWidget.LocalizeBehavior,
				Polymer.D2L.SearchWidget.UtilityBehavior
			],
			ready: function() {
				this._handleFocusBound = this._handleFocus.bind(this);
				this._handleClickBound = this._handleClick.bind(this);
			},
			attached: function() {
				var i = 0;
				var searchBarElements = this.$$('.search-bar').children;

				for (i = 0; i < searchBarElements.length; i++) {
					this.listen(searchBarElements[i], 'focus', '_onElementFocus');
				}

				document.body.addEventListener('focus', this._handleFocusBound, true);
				document.body.addEventListener('click', this._handleClickBound, true);

				this._listboxes = Polymer.dom(this.root).querySelectorAll('d2l-search-listbox').slice();

				for (i = 0; i < this._listboxes.length; i++) {
					this._listboxes[i].owner = this.$$('input');
				}

				this._initializePreviousSearches();
			},
			detached: function() {
				var searchBarElements = this.$$('.search-bar').children;
				for (var i = 0; i < searchBarElements.length; i++) {
					this.unlisten(searchBarElements[i], 'focus', '_onElementFocus');
				}

				document.body.removeEventListener('focus', this._handleFocusBound, true);
				document.body.removeEventListener('click', this._handleClickBound, true);
			},
			/*
			* Retrieves previous searches from local storage to populate listbox
			*/
			_initializePreviousSearches: function() {
				if (window.localStorage.getItem('searchWidget.previousSearches')) {
					try {
						var prevSearchObject = JSON.parse(window.localStorage.getItem('searchWidget.previousSearches'));

						if (prevSearchObject.hasOwnProperty('searches') && prevSearchObject.searches instanceof Array) {
							this._previousSearches = prevSearchObject.searches;
						}
					} catch (exception) {
						window.localStorage.removeItem('searchWidget.previousSearches');
						this._previousSearches = [];
					}
				}
			},
			_clearSearchResults: function() {
				this.cancelDebouncer('liveSearchJob');
				this.$$('iron-pages').select('recent-searches-page');
				this._searchString = '';
				this.set('_searchResults', []);
			},
			_onSearchActionChanged: function(searchAction) {
				// Siren parser can only parse entities, so make a fake one with the given action
				var entity = {
					actions: [ searchAction ]
				};
				var parser = document.createElement('d2l-siren-parser');
				this._searchAction = parser.parse(entity).actions[0];
			},
			_onSearchButtonClick: function() {
				if (!this._searchAction) {
					return;
				}

				var query = {};
				query[this.searchFieldName] = this._searchString;

				this._searchUrl = this.createActionUrl(this._searchAction, query);
				this.$.searchRequest.generateRequest();
			},
			_onSearchInputKeyPressed: function(e) {
				var keyCodes = {
					DOWN: 40,
					UP: 38,
					ENTER: 13
				};

				switch (e.keyCode) {
					case keyCodes.ENTER:
						this.$.searchRequest.generateRequest();
						break;

					case keyCodes.DOWN:
						if (this._currentListbox.hasItems()) {
							this._currentListbox.focus();
						}
						e.preventDefault();
						break;

					case keyCodes.UP:
						if (this._currentListbox.hasItems()) {
							this._currentListbox.focusLast();
						}
						e.preventDefault();
						break;
				}
			},
			_onSearchStringChanged: function(newString) {
				if (!this.liveSearch) {
					// If live search isn't enabled, we don't do anything on a text change
					return;
				}

				if (newString.length > 0) {
					this.debounce('liveSearchJob', function() {
						this.cancelDebouncer('liveSearchJob');

						// Live searching is like mashing Enter between each debounced keypress
						this._onSearchButtonClick();
					}.bind(this), 250);
				} else {
					this._clearSearchResults();
				}
			},
			_onSearchResponse: function(response) {
				if (response.detail.status === 200) {
					var parser = document.createElement('d2l-siren-parser');
					var searchResponse = parser.parse(response.detail.xhr.response);
					this._searchResults = searchResponse.entities;

					this.$$('iron-pages').select(this._searchResults.length > 0 ? 'search-results-page' : 'no-results-page');
				}
			},
			/*
			 * Adds a search term to the list of recent searches.
			 * @param {String} Search string
			 */
			_addSearchToHistory: function(searchTerm) {
				var previousSearches = this._previousSearches.slice();

				// Remove prior existence of this search term if it exists
				var currSearchHistoryIndex = previousSearches.indexOf(searchTerm);

				if (currSearchHistoryIndex !== -1) {
					previousSearches.splice(currSearchHistoryIndex, 1);
				}

				if (previousSearches.unshift(searchTerm) > 5) {
					previousSearches.splice(previousSearches.length - 1, 1);
				}

				try {
					window.localStorage.setItem(
						'searchWidget.previousSearches',
						JSON.stringify({
							searches: previousSearches
						})
					);
				} catch (e) {
					// Local storage not available/full - oh well.
				}
			},
			/*
			* Handles iron-select events, which are fired when listbox items are selected and dropdown pages are changed
			*/
			_onIronSelect: function(e) {
				switch (e.target.nodeName) {
					case 'IRON-PAGES':
						// @TODO: Not a fan of any of this "current listbox" handling - necessary right now due to Iron Behavior regressions.
						// Should find a better way.
						var ironPages = this.$$('iron-pages');
						var pageIndex = ironPages.indexOf(ironPages.selectedItem);
						this._currentListbox = this._listboxes[pageIndex];
						break;

					case 'D2L-SEARCH-LISTBOX':
						if (e.detail.item.dataset.href) {
							if (e.detail.item.dataset.text) {
								this._addSearchToHistory(e.detail.item.dataset.text);
							}

							window.location.href = e.detail.item.dataset.href;
						}
						break;
				}
			},
			/*
			 * Called when an element within the search bar gains focus, to open the dropdown.
			 */
			_onElementFocus: function() {
				if (!this.$.dropdown.opened) {
					this.$.dropdown.open();
				}
			},
			/*
			 * Handles loss of focus of this element due to focus event.
			 */
			_handleFocus: function() {
				this._checkFocusLost(document.activeElement);
			},
			/*
			 * Handles loss of focus of this element due to click event.
			 */
			_handleClick: function(e) {
				this._checkFocusLost(Polymer.dom(e).rootTarget);
			},
			/*
			* Determines whether the widget has lost focus, and closes the dropdown if it has.
			*/
			_checkFocusLost: function(focusedElement) {
				if (this.$.dropdown.opened && !this._isDescendant(focusedElement)) {
					this.$.dropdown.close();
				}
			},
			/*
			 * Determines whether the given element is a descendant of this element.
			 */
			_isDescendant: function(element) {
				var parentNode = element.parentNode;
				while (parentNode) {
					if (Polymer.dom(parentNode).node === this) {
						return true;
					}
					parentNode = parentNode.parentNode;
				}
				return false;
			}
		});
	</script>
</dom-module>
